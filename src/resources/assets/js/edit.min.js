$(function(){var t={},e=function(){$("input.date[property]").each(function(){var t=$(this),e=t.attr("property"),i=$('input.time[property="'+e+'"]'),r=$('.datepicker[property="'+e+'"]'),n=($('.datetime-container[property="'+e+'"]'),$('.timepicker-popup[property="'+e+'"]'));t.calendar({triggerElement:'.datepicker[property="'+e+'"]',dateFormat:"%Y-%m-%d",selectHandler:function(){r.html(this.date.print("%d.%m.%Y")),t.val(this.date.print(this.dateFormat)),i.val()||(i.val("00:00:00"),n.find('table.hours td[value="00"]').addClass("active"),n.find('table.minutes td[value="00"]').addClass("active"),n.find('table.seconds td[value="00"]').addClass("active"),r.after(', <span class="timepicker" property="'+e+'">'+i.val()+"</span>"))}})}),$("input.one").each(function(){var t=$(this).parents("div.row"),e=$(this).attr("item"),i=$(this).attr("property"),r=$(this).outerWidth()-2;$(this).autocomplete({serviceUrl:"/moonlight/elements/autocomplete",params:{item:e},formatResult:function(t,e){return t.value+" <small>("+t.id+")</small>"},onSelect:function(e){t.find('input:hidden[name="'+i+'"]').val(e.id),t.find('span[container][name="'+i+'"]').html(e.value)},width:r,minChars:0})}),$("input.many").each(function(){$(this);var e=$(this).parents("div.row"),i=$(this).attr("item"),r=$(this).attr("property"),n=$(this).outerWidth()-2;$(this).autocomplete({serviceUrl:"/moonlight/elements/autocomplete",params:{item:i},formatResult:function(t,e){return t.value+" <small>("+t.id+")</small>"},onSelect:function(i){t=i,e.find('span[container][name="'+r+'"]').html(i.value)},width:n,minChars:0})})};$("body").on("click",".timepicker[property]",function(t){t.stopPropagation();var e=$(this),i=e.attr("property"),r=$('.timepicker-popup[property="'+i+'"]'),n=($('input.time[property="'+i+'"]'),$(".main")),o=e.offset().left-n.offset().left,a=e.offset().top-n.offset().top;r.css({left:o+"px",top:a+"px"}).fadeToggle(200)}),$("body").on("click",".timepicker-popup",function(t){t.stopPropagation()}),$("body").on("click",".timepicker-popup .title.minutes",function(t){$(".timepicker-popup table.minutes td.add").toggleClass("hide")}),$("body").on("click",".timepicker-popup .title.seconds",function(t){$(".timepicker-popup table.seconds td.add").toggleClass("hide")}),$("body").on("click",".timepicker-popup table.hours td, .timepicker-popup table.minutes td, .timepicker-popup table.seconds td",function(t){var e=$(this),i=e.parents("table"),r=e.parents(".timepicker-popup"),n=r.attr("property"),o=(e.text(),$('input.time[property="'+n+'"]')),a=$('.timepicker[property="'+n+'"]');i.find("td.active").removeClass("active"),e.addClass("active");var l=r.find("table.hours td.active").text()+":"+r.find("table.minutes td.active").text()+":"+r.find("table.seconds td.active").text();a.html(l),o.val(l)}),$("body").on("click",".addition.unset[property]",function(t){var e=$(this).parents("div.row"),i=$(this).attr("property");e.find('input:hidden[name="'+i+'"]').val(""),e.find('input:text[name="'+i+'_autocomplete"]').val(""),e.find('span[container][name="'+i+'"]').html("Не определено")}),$("body").on("click",".addition.add[property]",function(e){var i=$(this).parents("div.row"),r=$(this).attr("property"),n=$('.many.elements[name="'+r+'"]');if(t.id){var o=$('input:checkbox[name="'+r+'[]"][id="'+t.classId+'"]');o.length?o.prop("checked",!0):n.append('<p><input type="checkbox" name="'+r+'[]" id="'+t.classId+'" checked value="'+t.id+'"><label for="'+t.classId+'">'+t.value+"</label></p>"),t={}}i.find('input:text[name="'+r+'_autocomplete"]').val(""),i.find('span[container][name="'+r+'"]').html("")}),$("body").on("change",".loadfile :file",function(t){var e=$(this).attr("name"),i=t.target.files[0]?t.target.files[0].name:"Выберите файл";$('.file[name="'+e+'"]').html(i),$('[name="'+e+'_drop"]').prop("checked",!1)}),$("body").on("click",".loadfile .file[name]",function(){var t=$(this).attr("name");$(':file[name="'+t+'"]').click()}),$("body").on("click",".loadfile .reset",function(){var t=$(this).attr("name");$('[name="'+t+'drop"]').prop("checked",!1),$('.file[name="'+t+'"]').html("Выберите файл"),$(':file[name="'+t+'"]').val("")}),tinymce.init({selector:'textarea[tinymce="true"]',themes:"modern",skin:"custom",language:"ru",plugins:["lists","link","image","paste","table","code","preview"],width:"50rem",height:"20rem",convert_urls:!1,setup:function(t){t.on("keypress keydown",function(t){return $.onCtrlS(t)})}}),$("form").submit(function(){var t=$(this);return t.find("span.error").fadeOut(200),$('textarea[tinymce="true"]').each(function(){var t=$(this).attr("name");$(this).val(tinymce.get(t).getContent())}),$.blockUI(),$(this).ajaxSubmit({url:this.action,dataType:"json",success:function(i){if($.unblockUI(),i.error)$.alert(i.error);else if(i.errors)for(var r in i.errors)t.find('span.error[name="'+r+'"]').html(i.errors[r]).fadeIn(200);else if(i.added&&i.url)document.location.href=i.url;else if(i.views){for(var r in i.views)$('div.row[name="'+r+'"]').html(i.views[r]);e()}},error:function(t){$.unblockUI(),$.alert(t.statusText)}}),!1}),$(".button.save.enabled").click(function(){$("form").submit()}),$(".button.copy.enabled").click(function(){$.confirm(null,"#copy")}),$(".button.move.enabled").click(function(){$.confirm(null,"#move")}),$(".button.favorite.enabled").click(function(){$.confirm(null,"#favorite")}),$(".button.delete.enabled").click(function(){$.confirm(null,"#delete")}),$(".confirm .btn.copy").click(function(){var t=$(this).parents(".confirm"),e=$(this).attr("url");if(!e)return!1;$.confirmClose(),$.blockUI();var i=null;t.find('input[type="radio"]:checked:not(disabled), input[type="hidden"]').each(function(){var t=$(this).attr("property"),e=$(this).val();i={name:t,value:e}}),$.post(e,i,function(t){$.unblockUI(function(){t.error?$.alert(t.error):t.copied&&t.url&&(location.href=t.url)})}).fail(function(){$.unblockUI(),$.alertDefaultError()})}),$(".confirm .btn.move").click(function(){var t=$(this).parents(".confirm"),e=$(this).attr("url");if(!e)return!1;var i=null;if(t.find('input[type="radio"]:checked:not(:disabled), input[type="hidden"]').each(function(){var t=$(this).attr("property"),e=$(this).val();i={name:t,value:e}}),!i)return!1;$.confirmClose(),$.blockUI(),$.post(e,i,function(t){$.unblockUI(function(){t.error?$.alert(t.error):t.moved&&($.confirmClose(),location.reload())})}).fail(function(){$.unblockUI(),$.alertDefaultError()})}),$("body").on("click",".confirm .favorite-list.add div[rubric]",function(){var t=$(this).parents(".confirm"),e=t.attr("url"),i=$(this).attr("rubric");return!!e&&(!!i&&($.confirmClose(),$.blockUI(),void $.post(e,{add_favorite_rubric:i},function(e){$.unblockUI(function(){e.error?$.alert(e.error):e.added&&(t.find('.favorite-list.add div[rubric="'+e.added+'"]').attr("display","hide"),t.find('.favorite-list.remove div[rubric="'+e.added+'"]').attr("display","show"),t.find('.favorite-list.add div[rubric][display="show"]').length?t.find('div[name="add"], .favorite-list.add').show():t.find('div[name="add"], .favorite-list.add').hide(),t.find('div[name="remove"], .favorite-list.remove').show())})}).fail(function(){$.unblockUI(),$.alertDefaultError()})))}),$("body").on("click",".confirm .favorite-list.remove div[rubric]",function(){var t=$(this).parents(".confirm"),e=t.attr("url"),i=$(this).attr("rubric");return!!e&&(!!i&&($.confirmClose(),$.blockUI(),void $.post(e,{remove_favorite_rubric:i},function(e){$.unblockUI(function(){e.error?$.alert(e.error):e.removed&&(t.find('.favorite-list.add div[rubric="'+e.removed+'"]').attr("display","show"),t.find('.favorite-list.remove div[rubric="'+e.removed+'"]').attr("display","hide"),t.find('div[name="add"], .favorite-list.add').show(),t.find('.favorite-list.remove div[rubric][display="show"]').length?t.find('div[name="remove"], .favorite-list.remove').show():t.find('div[name="remove"], .favorite-list.remove').hide())})}).fail(function(){$.unblockUI(),$.alertDefaultError()})))}),$('.confirm .favorite-new input[type="text"]').on("keypress",function(t){if(t||(t=window.event),t.keyCode)var e=t.keyCode;else if(t.which)e=t.which;13==e&&$(this).parents(".confirm").find(".btn.favorite").click()}),$(".confirm .btn.favorite").click(function(){var t=$(this).parents(".confirm"),e=t.attr("url"),i=t.find('.favorite-new input[type="text"]').val();return!!e&&(!!i&&($.confirmClose(),$.blockUI(),void $.post(e,{new_favorite_rubric:i},function(e){$.unblockUI(function(){e.error?$.alert(e.error):e.new?(t.find(".favorite-list.remove").append('<div rubric="'+e.new.id+'">'+e.new.name+"</div>"),t.find('.favorite-new input[type="text"]').val(""),t.find('div[name="remove"], .favorite-list.remove').show()):e.added&&(t.find('.favorite-list.add div[rubric="'+e.added+'"]').attr("display","hide"),t.find('.favorite-list.remove div[rubric="'+e.added+'"]').attr("display","show"),t.find('.favorite-new input[type="text"]').val(""),t.find('.favorite-list.add div[rubric][display="show"]').length?t.find('div[name="add"], .favorite-list.add').show():t.find('div[name="add"], .favorite-list.add').hide(),t.find('div[name="remove"], .favorite-list.remove').show())})}).fail(function(){$.unblockUI(),$.alertDefaultError()})))}),$(".confirm .btn.remove").click(function(){var t=$(this).attr("url");if(!t)return!1;$.confirmClose(),$.blockUI(),$.post(t,{},function(t){$.unblockUI(function(){t.error?$.alert(t.error):t.deleted&&t.url&&(location.href=t.url)})}).fail(function(){$.unblockUI(),$.alertDefaultError()})}),$(".sidebar .elements .h2 span").click(function(){var t=$(this).parents(".elements"),e=t.attr("rubric"),i=t.attr("display"),r=t.find("ul").first();"show"==i?(t.attr("display","hide"),r.hide(),$.post("/moonlight/rubrics/close",{rubric:e})):"hide"==i?(t.attr("display","show"),r.show(),$.post("/moonlight/rubrics/open",{rubric:e})):($.blockUI(),$.getJSON("/moonlight/rubrics/get",{rubric:e},function(e){$.unblockUI(),e.html&&(t.append(e.html),t.attr("display","show"))}))}),$("body").on("click",".sidebar .elements span.open",function(){var t=$(this),e=t.parents("li").first(),i=t.attr("rubric"),r=t.attr("bind"),n=t.attr("classId"),o=t.attr("display");"show"==o?($('.sidebar .elements ul[node="'+n+'"]').slideUp(200),t.attr("display","hide"),$.post("/moonlight/rubrics/node/close",{rubric:i,classId:n})):"hide"==o?($('.sidebar .elements ul[node="'+n+'"]').slideDown(200),t.attr("display","show"),$.post("/moonlight/rubrics/node/open",{rubric:i,classId:n})):($.blockUI(),$.getJSON("/moonlight/rubrics/node/get",{rubric:i,bind:r,classId:n},function(i){$.unblockUI(),i.html&&($(i.html).hide().appendTo(e).slideDown(200),t.attr("display","show"))}))}),$("body").on("contextmenu",".sidebar .elements a",function(t){t.preventDefault(),t.stopPropagation();var e=$(this),i=$(".sidebar"),r=$(".sidebar .contextmenu"),n=e.offset().left,o=e.offset().top-i.offset().top+e.height()+2;r.find("li.title span").html(e.text()),r.find("li.title small").html(e.attr("item")),r.find("li.edit a").attr("href",e.attr("href")+"/edit"),r.find("li.browse a").attr("href",e.attr("href")),o+r.height()>$(window).height()&&(o=o-r.height()-e.height()-4<0?0:o-r.height()-e.height()-4),r.css({left:n+"px",top:o+"px"}).fadeIn(200)}),$("body").on("click",".sidebar .contextmenu",function(t){t.stopPropagation()}),e(),$("div.item").fadeIn(200)});